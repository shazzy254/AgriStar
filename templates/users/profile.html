{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile - AgriStar{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 30px 30px;
    }

    .profile-avatar-container {
        position: relative;
        display: inline-block;
    }

    .profile-avatar {
        width: 150px;
        height: 150px;
        border: 5px solid white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border-radius: 50%;
        object-fit: cover;
    }

    .avatar-edit-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        color: #2ecc71;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .avatar-edit-btn:hover {
        transform: scale(1.1);
    }

    .badge-display {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        border-radius: 50px;
        font-weight: bold;
        margin-top: 1rem;
        background: rgba(255, 255, 255, 0.2);
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
        text-align: center;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2ecc71;
    }

    .product-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .product-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    .product-image {
        height: 200px;
        object-fit: cover;
        width: 100%;
    }

    .nav-pills .nav-link {
        border-radius: 50px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s;
    }

    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .action-btn {
        border-radius: 50px;
        padding: 0.5rem 1.5rem;
        font-weight: bold;
        transition: all 0.3s;
    }

    .action-btn:hover {
        transform: translateY(-2px);
    }

    .review-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="profile-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-3 text-center">
                <div class="profile-avatar-container">
                    <img src="{{ user.profile.avatar.url }}" class="profile-avatar" alt="{{ user.username }}">
                    <button class="avatar-edit-btn" data-bs-toggle="modal" data-bs-target="#changePhotoModal"
                        title="Change Photo">
                        <i class="bi bi-camera-fill"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-9">
                <h1 class="display-4 fw-bold mb-2">{{ user.username }}</h1>
                <p class="lead mb-3">
                    <i class="bi bi-geo-alt-fill me-2"></i>{{ user.profile.location|default:"Location not set" }}
                </p>

                <!-- Rating -->
                <div class="mb-3">
                    <span class="fs-5">
                        <i class="bi bi-star-fill text-warning"></i>
                        {{ user.profile.average_rating|default:0|floatformat:1 }}
                        <span class="opacity-75">({{ user.profile.total_reviews }} reviews)</span>
                    </span>
                </div>

                <!-- Badge -->
                {% if user.profile.badge != 'NONE' %}
                <div class="badge-display">
                    <i class="{{ user.profile.get_badge_icon }} me-2"></i>
                    {{ user.profile.get_badge_display }}
                </div>
                {% endif %}

                <!-- Management Buttons -->
                <div class="mt-4 d-flex gap-2 flex-wrap">
                    <button class="btn btn-light action-btn" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="bi bi-gear-fill me-2"></i>Settings
                    </button>
                    <a href="{% url 'create_product' %}" class="btn btn-outline-light action-btn">
                        <i class="bi bi-plus-circle me-2"></i>Add Product
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Section -->
<div class="container mb-5">
    <div class="row g-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ products.count }}</div>
                <p class="text-muted mb-0">Products</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ user.profile.total_sales }}</div>
                <p class="text-muted mb-0">Total Sales</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ user.profile.successful_deliveries }}</div>
                <p class="text-muted mb-0">Deliveries</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ user.favorited_by.count }}</div>
                <p class="text-muted mb-0">Favorites</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container pb-5">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">About</h5>
                    <p>{{ user.profile.bio|default:"No bio available" }}</p>

                    {% if user.role == 'FARMER' %}
                    <hr>
                    <h6 class="fw-bold">Farm Details</h6>
                    <p class="small mb-1"><strong>Size:</strong> {{ user.profile.farm_size|default:"Not specified" }}
                    </p>
                    <p class="small mb-0"><strong>Main Crops:</strong> {{ user.profile.main_crops|default:"Not
                        specified" }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-md-9">
            <!-- Tabs -->
            <ul class="nav nav-pills mb-4" role="tablist">
                <li class="nav-item me-2">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#products">
                        <i class="bi bi-grid me-2"></i>My Products
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#reviews">
                        <i class="bi bi-star me-2"></i>Reviews ({{ reviews.count }})
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Products Tab -->
                <div class="tab-pane fade show active" id="products">
                    <div class="d-flex justify-content-end mb-3">
                        <a href="{% url 'create_product' %}" class="btn btn-success rounded-pill">
                            <i class="bi bi-plus-lg me-2"></i>Add New Product
                        </a>
                    </div>

                    {% if products %}
                    <div class="row g-4">
                        {% for product in products %}
                        <div class="col-md-4">
                            <div class="card product-card h-100">
                                {% if product.image %}
                                <img src="{{ product.image.url }}" class="product-image" alt="{{ product.name }}">
                                {% else %}
                                <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                    <i class="bi bi-image text-muted fs-1"></i>
                                </div>
                                {% endif %}
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">{{ product.name }}</h5>
                                    <p class="text-success fw-bold mb-2">Ksh {{ product.price }} / {{ product.unit }}
                                    </p>

                                    <div class="mt-auto d-flex gap-2">
                                        <a href="{% url 'edit_product' product.id %}"
                                            class="btn btn-sm btn-outline-warning flex-fill">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button
                                            onclick="deleteProduct('{{ product.id }}', '{{ product.name|escapejs }}')"
                                            class="btn btn-sm btn-outline-danger flex-fill">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <a href="{% url 'product_detail' product.id %}"
                                            class="btn btn-sm btn-outline-success flex-fill">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="text-muted mt-3">No products listed yet</p>
                        <a href="{% url 'create_product' %}" class="btn btn-primary mt-2">List Your First Product</a>
                    </div>
                    {% endif %}
                </div>

                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews">
                    {% if reviews %}
                    {% for review in reviews %}
                    <div class="review-card">
                        <div class="d-flex align-items-start">
                            <img src="{{ review.reviewer.profile.avatar.url }}" class="rounded-circle me-3" width="50"
                                height="50" alt="{{ review.reviewer.username }}">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1 fw-bold">{{ review.reviewer.username }}</h6>
                                        <div class="text-warning">
                                            {{ review.rating }} <i class="bi bi-star-fill"></i>
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ review.created_at|timesince }} ago</small>
                                </div>
                                <p class="mt-2 mb-0">{{ review.comment }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-chat-quote display-1 text-muted"></i>
                        <p class="text-muted mt-3">No reviews yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gear-fill me-2"></i>Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Settings Tabs -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#editProfileTab">
                            <i class="bi bi-person-circle me-2"></i>Edit Profile
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link text-danger" data-bs-toggle="tab" data-bs-target="#deleteAccountTab">
                            <i class="bi bi-trash me-2"></i>Delete Account
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Edit Profile Tab -->
                    <div class="tab-pane fade show active" id="editProfileTab">
                        <form method="POST" action="{% url 'edit_profile' %}">
                            {% csrf_token %}
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Username</label>
                                    <input type="text" name="username" class="form-control" value="{{ user.username }}"
                                        required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="form-control" value="{{ user.email }}"
                                        required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" name="phone_number" class="form-control"
                                        value="{{ user.profile.phone_number|default:'' }}"
                                        placeholder="e.g., 0712345678">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">WhatsApp Number</label>
                                    <input type="tel" name="whatsapp_number" class="form-control"
                                        value="{{ user.profile.whatsapp_number|default:'' }}"
                                        placeholder="e.g., 254712345678">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Location</label>
                                    <input type="text" name="location" class="form-control"
                                        value="{{ user.profile.location|default:'' }}"
                                        placeholder="e.g., Nairobi, Kenya">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Bio</label>
                                    <textarea name="bio" class="form-control" rows="3"
                                        placeholder="Tell us about yourself...">{{ user.profile.bio|default:'' }}</textarea>
                                </div>

                                {% if user.role == 'FARMER' %}
                                <div class="col-md-6">
                                    <label class="form-label">Farm Size</label>
                                    <input type="text" name="farm_size" class="form-control"
                                        value="{{ user.profile.farm_size|default:'' }}" placeholder="e.g., 5 acres">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Main Crops</label>
                                    <input type="text" name="main_crops" class="form-control"
                                        value="{{ user.profile.main_crops|default:'' }}"
                                        placeholder="e.g., Maize, Beans">
                                </div>
                                {% endif %}

                                {% if user.role == 'SUPPLIER' %}
                                <div class="col-12">
                                    <label class="form-label">Company Name</label>
                                    <input type="text" name="company_name" class="form-control"
                                        value="{{ user.profile.company_name|default:'' }}"
                                        placeholder="Your company name">
                                </div>
                                {% endif %}
                            </div>
                            <div class="mt-4 d-flex gap-2 justify-content-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-circle me-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Delete Account Tab -->
                    <div class="tab-pane fade" id="deleteAccountTab">
                        <div class="alert alert-danger">
                            <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Danger Zone
                            </h5>
                            <p class="mb-0">Once you delete your account, there is no going back. Please be certain.</p>
                        </div>

                        <div class="card border-danger">
                            <div class="card-body">
                                <h6 class="card-title text-danger fw-bold">Delete Your Account</h6>
                                <p class="card-text text-muted small">
                                    This will permanently delete your account, including:
                                </p>
                                <ul class="small text-muted">
                                    <li>Your profile information</li>
                                    <li>All your products and listings</li>
                                    <li>Your order history</li>
                                    <li>All reviews and ratings</li>
                                    <li>Any saved data</li>
                                </ul>
                                <form method="POST" action="{% url 'delete_account' %}"
                                    onsubmit="return confirm('Are you absolutely sure? This action cannot be undone!');">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label class="form-label">Type <strong>DELETE</strong> to confirm:</label>
                                        <input type="text" class="form-control" id="deleteConfirm" placeholder="DELETE"
                                            required>
                                    </div>
                                    <button type="submit" class="btn btn-danger" id="deleteBtn" disabled>
                                        <i class="bi bi-trash me-2"></i>Permanently Delete Account
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Photo Modal -->
<div class="modal fade" id="changePhotoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Profile Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Main Menu -->
                <div id="photoMenuView">
                    <div class="text-center mb-4">
                        <img src="{{ user.profile.avatar.url }}" id="currentAvatar" class="rounded-circle mb-3"
                            width="150" height="150" style="object-fit: cover;">
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" onclick="showCameraView()">
                            <i class="bi bi-camera me-2"></i>Take Photo
                        </button>
                        <button type="button" class="btn btn-success"
                            onclick="document.getElementById('galleryInput').click()">
                            <i class="bi bi-image me-2"></i>Choose from Gallery
                        </button>
                        <button type="button" class="btn btn-info" onclick="showViewPhotoView()">
                            <i class="bi bi-eye me-2"></i>View Photo
                        </button>
                        {% if user.profile.avatar and user.profile.avatar.name != 'avatars/default.png' %}
                        <button type="button" class="btn btn-danger" onclick="removePhoto()">
                            <i class="bi bi-trash me-2"></i>Remove Photo
                        </button>
                        {% endif %}
                    </div>
                    <input type="file" id="galleryInput" accept="image/*" style="display: none;"
                        onchange="handleGalleryUpload(event)">
                </div>

                <!-- Camera View -->
                <div id="cameraView" style="display: none;">
                    <div class="text-center">
                        <video id="cameraStream" width="100%" height="auto" autoplay
                            style="border-radius: 15px; max-height: 400px;"></video>
                        <canvas id="photoCanvas" style="display: none;"></canvas>
                    </div>
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <button type="button" class="btn btn-secondary" onclick="stopCamera()">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="capturePhoto()">
                            <i class="bi bi-camera me-2"></i>Capture
                        </button>
                    </div>
                </div>

                <!-- Photo Preview View -->
                <div id="photoPreviewView" style="display: none;">
                    <div class="text-center">
                        <img id="previewImage" src="" class="img-fluid rounded mb-3" style="max-height: 400px;">
                    </div>
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-danger" onclick="retakePhoto()">
                            <i class="bi bi-x-circle me-2"></i>Retake
                        </button>
                        <button type="button" class="btn btn-success" onclick="confirmPhoto()">
                            <i class="bi bi-check-circle me-2"></i>Confirm
                        </button>
                    </div>
                </div>

                <!-- View Photo View -->
                <div id="viewPhotoView" style="display: none;">
                    <div class="text-center">
                        <img src="{{ user.profile.avatar.url }}" class="img-fluid rounded mb-3"
                            style="max-height: 500px;">
                    </div>
                    <div class="text-center">
                        <button type="button" class="btn btn-secondary" onclick="showPhotoMenu()">
                            <i class="bi bi-arrow-left me-2"></i>Back
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Delete Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger fw-bold">⚠️ Warning: This action cannot be undone!</p>
                <p>Are you absolutely sure you want to delete your account?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{% url 'delete_account' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Yes, Delete My Account</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let cameraStream = null;
    let capturedPhotoBlob = null;

    function showPhotoMenu() {
        document.getElementById('photoMenuView').style.display = 'block';
        document.getElementById('cameraView').style.display = 'none';
        document.getElementById('photoPreviewView').style.display = 'none';
        document.getElementById('viewPhotoView').style.display = 'none';
    }

    function showCameraView() {
        document.getElementById('photoMenuView').style.display = 'none';
        document.getElementById('cameraView').style.display = 'block';
        startCamera();
    }

    function showViewPhotoView() {
        document.getElementById('photoMenuView').style.display = 'none';
        document.getElementById('viewPhotoView').style.display = 'block';
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user' },
                audio: false
            });
            const video = document.getElementById('cameraStream');
            video.srcObject = stream;
            cameraStream = stream;
        } catch (error) {
            alert('Unable to access camera. Please check permissions.');
            showPhotoMenu();
        }
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        showPhotoMenu();
    }

    function capturePhoto() {
        const video = document.getElementById('cameraStream');
        const canvas = document.getElementById('photoCanvas');
        const context = canvas.getContext('2d');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);

        canvas.toBlob(function (blob) {
            capturedPhotoBlob = blob;
            const url = URL.createObjectURL(blob);
            document.getElementById('previewImage').src = url;

            // Stop camera and show preview
            stopCamera();
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('photoPreviewView').style.display = 'block';
        }, 'image/jpeg', 0.95);
    }

    function retakePhoto() {
        capturedPhotoBlob = null;
        document.getElementById('photoPreviewView').style.display = 'none';
        showCameraView();
    }

    function handleGalleryUpload(event) {
        const file = event.target.files[0];
        if (file) {
            capturedPhotoBlob = file;
            const url = URL.createObjectURL(file);
            document.getElementById('previewImage').src = url;

            document.getElementById('photoMenuView').style.display = 'none';
            document.getElementById('photoPreviewView').style.display = 'block';
        }
    }

    async function confirmPhoto() {
        if (!capturedPhotoBlob) {
            alert('No photo selected');
            return;
        }

        const formData = new FormData();
        formData.append('avatar', capturedPhotoBlob, 'profile-photo.jpg');

        try {
            const response = await fetch('{% url "update_profile_photo" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // Update avatar images on page
                document.getElementById('currentAvatar').src = data.avatar_url + '?t=' + new Date().getTime();
                document.querySelectorAll('.profile-avatar').forEach(img => {
                    img.src = data.avatar_url + '?t=' + new Date().getTime();
                });

                // Close modal and reset
                bootstrap.Modal.getInstance(document.getElementById('changePhotoModal')).hide();
                showPhotoMenu();
                capturedPhotoBlob = null;

                // Show success message
                alert('Profile photo updated successfully!');
            } else {
                alert('Error updating photo: ' + data.error);
            }
        } catch (error) {
            alert('Error uploading photo: ' + error.message);
        }
    }

    async function removePhoto() {
        if (!confirm('Are you sure you want to remove your profile photo?')) {
            return;
        }

        const formData = new FormData();
        formData.append('remove_photo', 'true');

        try {
            const response = await fetch('{% url "update_profile_photo" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                location.reload();
            } else {
                alert('Error removing photo: ' + data.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Reset modal when closed
    document.getElementById('changePhotoModal').addEventListener('hidden.bs.modal', function () {
        stopCamera();
        showPhotoMenu();
        capturedPhotoBlob = null;
    });

    function deleteProduct(productId, productName) {
        if (confirm(`Are you sure you want to delete "${productName}"?`)) {
            fetch(`/marketplace/product/${productId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting product');
                    }
                });
        }
    }

    // Delete account confirmation
    const deleteConfirmInput = document.getElementById('deleteConfirm');
    const deleteBtn = document.getElementById('deleteBtn');

    if (deleteConfirmInput && deleteBtn) {
        deleteConfirmInput.addEventListener('input', function () {
            if (this.value === 'DELETE') {
                deleteBtn.disabled = false;
                deleteBtn.classList.remove('btn-danger');
                deleteBtn.classList.add('btn-danger');
            } else {
                deleteBtn.disabled = true;
            }
        });
    }
</script>
{% endblock %}